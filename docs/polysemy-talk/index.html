<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Polysemy: Chasing Performance in Free Monads :: Reasonably Polymorphic</title>
        <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
        <link href="/atom.xml" rel="alternate" title="Reasonably Polymorphic - Atom" type="application/atom+xml" />
        <link href="/feed.rss" rel="alternate" title="Reasonably Polymorphic - RSS" type="application/rss+xml" />

        <link href='https://fonts.googleapis.com/css?family=Amiri|Muli' rel='stylesheet' type='text/css' />
        <link href="/css/style.css" type="text/css" rel="stylesheet" />
        <link href="/css/syntax.css" type="text/css" rel="stylesheet" />

        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                    "HTML-CSS": {
                        scale: 100
                    },
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
  TeX: {extensions: [ "AMSmath.js"
                    , "AMSsymbols.js"
                    , "color.js"
                    , "cancel.js"
                    , "http://sonoisa.github.io/xyjax_ext/xypic.js"
                    ]}
            });
        </script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>
          <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        
          ga('create', 'UA-76834556-1', 'auto');
          ga('send', 'pageview');
          </script>
        </head>
        <body>
<div class="main">

<article>
<header>
  <h1><a href="/polysemy-talk">Polysemy: Chasing Performance in Free Monads</a></h1>
</header>
<p class="meta">
    <time></time>

    <span class="tags">
        
    </span>
</p>
<div class="content">
    <h1 id="polysemy">Polysemy</h1>
<h2 id="chasing-performance-in-free-monads">Chasing Performance in Free Monads</h2>
<hr />
<ul>
<li><strong>Sandy Maguire</strong></li>
<li><p>sandy@sandymaguire.me</p></li>
<li>reasonablypolymorphic.com</li>
<li><p>github.com/isovector</p></li>
</ul>
<p>Today’s slides:</p>
<ul>
<li>reasonablypolymorphic.com/polysemy-talk</li>
</ul>
<hr />
<p>Our codebase was written by contractors.</p>
<p>Big ball o’ IO spaghetti.</p>
<p>Impossible to test.</p>
<hr />
<p><em>Free monads</em> are what I think programming will look like in 30 years.</p>
<div class="incremental">
<p>Write your applications in <em>domain specific language</em> designed for your exact problem.</p>
</div>
<div class="incremental">
<p><em>Run a series of transformations</em> to compile your high-level specification into lower-level DSLs.</p>
<hr />
<p>Most programs are easy to describe.</p>
</div>
<div class="incremental">
<p>The majority of a codebase is spent dealing with nitty-gritty details.</p>
</div>
<div class="incremental">
<p>This is where most of the bugs are.</p>
<hr />
<p>Let’s turn implementation details into library code!</p>
<hr />
</div>
<h1 id="example">Example</h1>
<p>Data ingestion service that:</p>
<ul>
<li>reads encrypted CSV files</li>
<li>emits them in batches to a streaming HTTP service</li>
<li>records statistics in Redis</li>
</ul>
<hr />
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1">ingest</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ot">    ::</span> ( <span class="dt">Member</span> (<span class="dt">Input</span> <span class="dt">Record</span>) r</a>
<a class="sourceLine" id="cb1-3" title="3">       , <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Record</span>) r</a>
<a class="sourceLine" id="cb1-4" title="4">       , <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Stat</span>) r</a>
<a class="sourceLine" id="cb1-5" title="5">       )</a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="ot">=&gt;</span> <span class="dt">Eff</span> r ()</a>
<a class="sourceLine" id="cb1-7" title="7">ingest <span class="fu">=</span> input <span class="fu">&gt;&gt;=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb1-8" title="8">  <span class="dt">Nothing</span>     <span class="ot">-&gt;</span> <span class="fu">pure</span> ()</a>
<a class="sourceLine" id="cb1-9" title="9">  <span class="dt">Just</span> record <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-10" title="10">    output record</a>
<a class="sourceLine" id="cb1-11" title="11">    output <span class="dt">ProcessedRecordStat</span></a>
<a class="sourceLine" id="cb1-12" title="12">    ingest</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1">main <span class="fu">=</span> ingest</a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ Input Record, Output Record, Output Stat }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb3-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FileProvider, Output Record, Output Stat }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb4-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a>
<a class="sourceLine" id="cb4-3" title="3">     <span class="fu">&amp;</span> decryptFileProvider</a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FileProvider, Output Record, Output Stat, Encryption }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb5-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a>
<a class="sourceLine" id="cb5-3" title="3">     <span class="fu">&amp;</span> decryptFileProvider</a>
<a class="sourceLine" id="cb5-4" title="4">     <span class="fu">&amp;</span> ftpFileProvider</a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FTP, Output Record, Output Stat, Encryption }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb6-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a>
<a class="sourceLine" id="cb6-3" title="3">     <span class="fu">&amp;</span> decryptFileProvider</a>
<a class="sourceLine" id="cb6-4" title="4">     <span class="fu">&amp;</span> ftpFileProvider</a>
<a class="sourceLine" id="cb6-5" title="5">     <span class="fu">&amp;</span> batch      <span class="fu">@</span><span class="dt">Record</span> <span class="dv">500</span></a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FTP, Output [Record], Output Stat, Encryption }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb7-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a>
<a class="sourceLine" id="cb7-3" title="3">     <span class="fu">&amp;</span> decryptFileProvider</a>
<a class="sourceLine" id="cb7-4" title="4">     <span class="fu">&amp;</span> ftpFileProvider</a>
<a class="sourceLine" id="cb7-5" title="5">     <span class="fu">&amp;</span> batch      <span class="fu">@</span><span class="dt">Record</span> <span class="dv">500</span></a>
<a class="sourceLine" id="cb7-6" title="6">     <span class="fu">&amp;</span> postOutput <span class="fu">@</span><span class="dt">Record</span> mkApiCall</a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FTP, HTTP, Output Stat, Encryption }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb8-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a>
<a class="sourceLine" id="cb8-3" title="3">     <span class="fu">&amp;</span> decryptFileProvider</a>
<a class="sourceLine" id="cb8-4" title="4">     <span class="fu">&amp;</span> ftpFileProvider</a>
<a class="sourceLine" id="cb8-5" title="5">     <span class="fu">&amp;</span> batch      <span class="fu">@</span><span class="dt">Record</span> <span class="dv">500</span></a>
<a class="sourceLine" id="cb8-6" title="6">     <span class="fu">&amp;</span> postOutput <span class="fu">@</span><span class="dt">Record</span> mkApiCall</a>
<a class="sourceLine" id="cb8-7" title="7">     <span class="fu">&amp;</span> redisOuput <span class="fu">@</span><span class="dt">Stat</span>   mkRedisKey</a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{FTP, HTTP, Encryption, Redis}</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb9-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a>
<a class="sourceLine" id="cb9-3" title="3">     <span class="fu">&amp;</span> decryptFileProvider</a>
<a class="sourceLine" id="cb9-4" title="4">     <span class="fu">&amp;</span> ftpFileProvider</a>
<a class="sourceLine" id="cb9-5" title="5">     <span class="fu">&amp;</span> batch      <span class="fu">@</span><span class="dt">Record</span> <span class="dv">500</span></a>
<a class="sourceLine" id="cb9-6" title="6">     <span class="fu">&amp;</span> postOutput <span class="fu">@</span><span class="dt">Record</span> mkApiCall</a>
<a class="sourceLine" id="cb9-7" title="7">     <span class="fu">&amp;</span> redisOuput <span class="fu">@</span><span class="dt">Stat</span>   mkRedisKey</a>
<a class="sourceLine" id="cb9-8" title="8">     <span class="fu">&amp;</span> runEncryption</a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FTP, HTTP, Redis}</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb10-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a>
<a class="sourceLine" id="cb10-3" title="3">     <span class="fu">&amp;</span> decryptFileProvider</a>
<a class="sourceLine" id="cb10-4" title="4">     <span class="fu">&amp;</span> ftpFileProvider</a>
<a class="sourceLine" id="cb10-5" title="5">     <span class="fu">&amp;</span> batch      <span class="fu">@</span><span class="dt">Record</span> <span class="dv">500</span></a>
<a class="sourceLine" id="cb10-6" title="6">     <span class="fu">&amp;</span> postOutput <span class="fu">@</span><span class="dt">Record</span> mkApiCall</a>
<a class="sourceLine" id="cb10-7" title="7">     <span class="fu">&amp;</span> redisOuput <span class="fu">@</span><span class="dt">Stat</span>   mkRedisKey</a>
<a class="sourceLine" id="cb10-8" title="8">     <span class="fu">&amp;</span> runEncryption</a>
<a class="sourceLine" id="cb10-9" title="9">     <span class="fu">&amp;</span> runHTTP</a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ FTP, Redis }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb11-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a>
<a class="sourceLine" id="cb11-3" title="3">     <span class="fu">&amp;</span> decryptFileProvider</a>
<a class="sourceLine" id="cb11-4" title="4">     <span class="fu">&amp;</span> ftpFileProvider</a>
<a class="sourceLine" id="cb11-5" title="5">     <span class="fu">&amp;</span> batch      <span class="fu">@</span><span class="dt">Record</span> <span class="dv">500</span></a>
<a class="sourceLine" id="cb11-6" title="6">     <span class="fu">&amp;</span> postOutput <span class="fu">@</span><span class="dt">Record</span> mkApiCall</a>
<a class="sourceLine" id="cb11-7" title="7">     <span class="fu">&amp;</span> redisOuput <span class="fu">@</span><span class="dt">Stat</span>   mkRedisKey</a>
<a class="sourceLine" id="cb11-8" title="8">     <span class="fu">&amp;</span> runEncryption</a>
<a class="sourceLine" id="cb11-9" title="9">     <span class="fu">&amp;</span> runHTTP</a>
<a class="sourceLine" id="cb11-10" title="10">     <span class="fu">&amp;</span> runFTP</a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ Redis }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb12-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a>
<a class="sourceLine" id="cb12-3" title="3">     <span class="fu">&amp;</span> decryptFileProvider</a>
<a class="sourceLine" id="cb12-4" title="4">     <span class="fu">&amp;</span> ftpFileProvider</a>
<a class="sourceLine" id="cb12-5" title="5">     <span class="fu">&amp;</span> batch      <span class="fu">@</span><span class="dt">Record</span> <span class="dv">500</span></a>
<a class="sourceLine" id="cb12-6" title="6">     <span class="fu">&amp;</span> postOutput <span class="fu">@</span><span class="dt">Record</span> mkApiCall</a>
<a class="sourceLine" id="cb12-7" title="7">     <span class="fu">&amp;</span> redisOuput <span class="fu">@</span><span class="dt">Stat</span>   mkRedisKey</a>
<a class="sourceLine" id="cb12-8" title="8">     <span class="fu">&amp;</span> runEncryption</a>
<a class="sourceLine" id="cb12-9" title="9">     <span class="fu">&amp;</span> runHTTP</a>
<a class="sourceLine" id="cb12-10" title="10">     <span class="fu">&amp;</span> runFTP</a>
<a class="sourceLine" id="cb12-11" title="11">     <span class="fu">&amp;</span> runRedis</a></code></pre></div>
<blockquote>
<p>Open Effects:</p>
<p>{ }</p>
</blockquote>
<hr />
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1">main <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb13-2" title="2">     <span class="fu">&amp;</span> csvInput <span class="st">&quot;file.csv&quot;</span></a>
<a class="sourceLine" id="cb13-3" title="3">     <span class="fu">&amp;</span> decryptFileProvider</a>
<a class="sourceLine" id="cb13-4" title="4">     <span class="fu">&amp;</span> ftpFileProvider</a>
<a class="sourceLine" id="cb13-5" title="5">     <span class="fu">&amp;</span> batch      <span class="fu">@</span><span class="dt">Record</span> <span class="dv">500</span></a>
<a class="sourceLine" id="cb13-6" title="6">     <span class="fu">&amp;</span> postOutput <span class="fu">@</span><span class="dt">Record</span> mkApiCall</a>
<a class="sourceLine" id="cb13-7" title="7">     <span class="fu">&amp;</span> redisOuput <span class="fu">@</span><span class="dt">Stat</span>   mkRedisKey</a>
<a class="sourceLine" id="cb13-8" title="8">     <span class="fu">&amp;</span> runEncryption</a>
<a class="sourceLine" id="cb13-9" title="9">     <span class="fu">&amp;</span> runHTTP</a>
<a class="sourceLine" id="cb13-10" title="10">     <span class="fu">&amp;</span> runFTP</a>
<a class="sourceLine" id="cb13-11" title="11">     <span class="fu">&amp;</span> runRedis</a>
<a class="sourceLine" id="cb13-12" title="12">     <span class="fu">&amp;</span> runM</a></code></pre></div>
<hr />
<p>But maybe we want to test this without a million mocked services?</p>
<div class="incremental">
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1"><span class="ot">test ::</span> ([<span class="dt">Stat</span>], ([<span class="dt">Record</span>], ()))</a>
<a class="sourceLine" id="cb14-2" title="2">test <span class="fu">=</span> ingest</a>
<a class="sourceLine" id="cb14-3" title="3">     <span class="fu">&amp;</span> runInput [record1, record2]</a>
<a class="sourceLine" id="cb14-4" title="4">     <span class="fu">&amp;</span> runPureOuput <span class="fu">@</span><span class="dt">Recor</span></a>
<a class="sourceLine" id="cb14-5" title="5">     <span class="fu">&amp;</span> runPureOuput <span class="fu">@</span><span class="dt">Stat</span></a>
<a class="sourceLine" id="cb14-6" title="6">     <span class="fu">&amp;</span> run</a></code></pre></div>
<hr />
<p>If both a test and real interpreter are correct,</p>
</div>
<div class="incremental">
<p>And the program is correct under the test,</p>
</div>
<div class="incremental">
<p>Then the program is correct under the real interpreter!</p>
</div>
<div class="incremental">
<p><strong>Correctness composes!</strong></p>
<hr />
<p>Two major players in the free monad space:</p>
</div>
<div class="incremental">
<h2 id="freer-simple">freer-simple</h2>
<ul>
<li>No boilerplate!</li>
<li>Friendly to use!</li>
<li>35x slower than theoretically possible.</li>
<li>Incapable of expressing lots of desirable effects.</li>
</ul>
<h2 id="fused-effects">fused-effects</h2>
<ul>
<li>SO MUCH BOILERPLATE.</li>
<li>Not very friendly.</li>
<li>As fast as possible!</li>
<li>All effects are expressible!</li>
</ul>
<div class="incremental">
<p><strong>Neither of these is a good trade-off!</strong></p>
<hr />
<p>My new library:</p>
</div>
<h2 id="polysemy-1">polysemy</h2>
<ul>
<li>No boilerplate!</li>
<li>Friendly to use!</li>
<li>As fast as possible!</li>
<li>All effects are expressible!</li>
</ul>
<div class="incremental">
<p><em>The best of both worlds!</em></p>
<hr />
<p>We’ll discuss how this was possible!</p>
</div>
<div class="incremental">
<p>But first, let’s get you up to speed on naive free monads.</p>
<hr />
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">data</span> <span class="dt">Teletype</span> k</a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="fu">=</span> <span class="dt">Done</span> k</a>
<a class="sourceLine" id="cb15-3" title="3">  <span class="fu">|</span> <span class="dt">WriteLine</span> <span class="dt">String</span> (<span class="dt">Teletype</span> k)</a>
<a class="sourceLine" id="cb15-4" title="4">  <span class="fu">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Teletype</span> k)</a>
<a class="sourceLine" id="cb15-5" title="5"></a>
<a class="sourceLine" id="cb15-6" title="6"></a>
<a class="sourceLine" id="cb15-7" title="7"><span class="ot">echo ::</span> <span class="dt">Teletype</span> ()</a>
<a class="sourceLine" id="cb15-8" title="8">echo <span class="fu">=</span> <span class="dt">ReadLine</span> <span class="fu">$</span> \msg <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb15-9" title="9">       <span class="dt">WriteLine</span> msg</a>
<a class="sourceLine" id="cb15-10" title="10">     <span class="fu">$</span> <span class="dt">Done</span> ()</a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">instance</span> <span class="dt">Monad</span> <span class="dt">Teletype</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb16-2" title="2">  <span class="fu">return</span> <span class="fu">=</span> <span class="dt">Done</span></a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="dt">Done</span>          k <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> f k</a>
<a class="sourceLine" id="cb16-4" title="4">  <span class="dt">WriteLine</span> msg k <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">WriteLine</span> msg <span class="fu">$</span> k <span class="fu">&gt;&gt;=</span> f</a>
<a class="sourceLine" id="cb16-5" title="5">  <span class="dt">ReadLine</span>      k <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">ReadLine</span> <span class="fu">$</span> \str <span class="ot">-&gt;</span> k str <span class="fu">&gt;&gt;=</span> f</a></code></pre></div>
<hr />
<p>Because it’s a monad, we can write this more idiomatically.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" title="1"><span class="ot">echo ::</span> <span class="dt">Teletype</span> ()</a>
<a class="sourceLine" id="cb17-2" title="2">echo <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb17-3" title="3">  msg <span class="ot">&lt;-</span> <span class="dt">ReadLine</span> <span class="dt">Done</span></a>
<a class="sourceLine" id="cb17-4" title="4">  <span class="dt">WriteLine</span> msg <span class="fu">$</span> <span class="dt">Done</span> ()</a></code></pre></div>
<hr />
<p>… and define evaluation semantics for it.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" title="1"><span class="ot">runTeletypeInIO ::</span> <span class="dt">Teletype</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</a>
<a class="sourceLine" id="cb18-2" title="2">runTeletypeInIO (<span class="dt">Done</span> a) <span class="fu">=</span> <span class="fu">pure</span> a</a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" title="1">runTeletypeInIO (<span class="dt">WriteLine</span> msg k) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb19-2" title="2">  <span class="fu">putStrLn</span> msg</a>
<a class="sourceLine" id="cb19-3" title="3">  runTeletypeInIO k</a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" title="1">runTeletypeInIO (<span class="dt">ReadLine</span> k) <span class="fu">=</span>  <span class="kw">do</span></a>
<a class="sourceLine" id="cb20-2" title="2">  msg <span class="ot">&lt;-</span> <span class="fu">getLine</span></a>
<a class="sourceLine" id="cb20-3" title="3">  runTeletypeInIO <span class="fu">$</span> k msg</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" title="1"><span class="ot">runTeletypePurely ::</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">Teletype</span> a <span class="ot">-&gt;</span> ([<span class="dt">String</span>], a)</a>
<a class="sourceLine" id="cb21-2" title="2">runTeletypePurely _ (<span class="dt">Done</span> a) <span class="fu">=</span> ([], a)</a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" title="1">runTeletypePurely ls (<span class="dt">WriteLine</span> msg k) <span class="fu">=</span></a>
<a class="sourceLine" id="cb22-2" title="2">  <span class="kw">let</span> (rs, a) <span class="fu">=</span> runTeletypePurely ls k</a>
<a class="sourceLine" id="cb22-3" title="3">   <span class="kw">in</span> (msg <span class="fu">:</span> rs, a)</a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" title="1">runTeletypePurely []       (<span class="dt">ReadLine</span> k) <span class="fu">=</span></a>
<a class="sourceLine" id="cb23-2" title="2">  runTeletypePurely [] <span class="fu">$</span> k <span class="st">&quot;&quot;</span></a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" title="1">runTeletypePurely (l <span class="fu">:</span> ls) (<span class="dt">ReadLine</span> k) <span class="fu">=</span></a>
<a class="sourceLine" id="cb24-2" title="2">  runTeletypePurely ls <span class="fu">$</span> k l</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb25-1" title="1"><span class="kw">data</span> <span class="dt">Teletype</span> k</a>
<a class="sourceLine" id="cb25-2" title="2">  <span class="fu">=</span> <span class="dt">Done</span> k</a>
<a class="sourceLine" id="cb25-3" title="3">  <span class="fu">|</span> <span class="dt">WriteLine</span> <span class="dt">String</span> (<span class="dt">Teletype</span> k)</a>
<a class="sourceLine" id="cb25-4" title="4">  <span class="fu">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Teletype</span> k)</a></code></pre></div>
<p>The <code>Done</code> constructor and the recursion are only necessary to make this a <code>Monad</code>.</p>
<p>We can factor them out.</p>
<hr />
<p>Before:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">data</span> <span class="dt">Teletype</span> k</a>
<a class="sourceLine" id="cb26-2" title="2">  <span class="fu">=</span> <span class="dt">Done</span> k</a>
<a class="sourceLine" id="cb26-3" title="3">  <span class="fu">|</span> <span class="dt">WriteLine</span> <span class="dt">String</span> (<span class="dt">Teletype</span> k)</a>
<a class="sourceLine" id="cb26-4" title="4">  <span class="fu">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Teletype</span> k)</a></code></pre></div>
<p>After:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb27-1" title="1"><span class="kw">data</span> <span class="dt">Free</span> f k</a>
<a class="sourceLine" id="cb27-2" title="2">  <span class="fu">=</span> <span class="dt">Pure</span> k</a>
<a class="sourceLine" id="cb27-3" title="3">  <span class="fu">|</span> <span class="dt">Impure</span> (f (<span class="dt">Free</span> f k))</a>
<a class="sourceLine" id="cb27-4" title="4"></a>
<a class="sourceLine" id="cb27-5" title="5"></a>
<a class="sourceLine" id="cb27-6" title="6"><span class="kw">data</span> <span class="dt">Teletype</span> a</a>
<a class="sourceLine" id="cb27-7" title="7">  <span class="fu">=</span> <span class="dt">WriteLine</span> <span class="dt">String</span> a</a>
<a class="sourceLine" id="cb27-8" title="8">  <span class="fu">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> a)</a></code></pre></div>
<hr />
<p><code>Free f</code> is a <code>Monad</code> whenever <code>f</code> is a <code>Functor</code>!</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb28-1" title="1"><span class="kw">instance</span> <span class="dt">Functor</span> f <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">Free</span> f) <span class="kw">where</span></a>
<a class="sourceLine" id="cb28-2" title="2">  <span class="fu">return</span> <span class="fu">=</span> <span class="dt">Pure</span></a>
<a class="sourceLine" id="cb28-3" title="3">  <span class="dt">Pure</span> k   <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> f k</a>
<a class="sourceLine" id="cb28-4" title="4">  <span class="dt">Impure</span> z <span class="fu">&gt;&gt;=</span> f <span class="fu">=</span> <span class="dt">Impure</span> <span class="fu">$</span> <span class="fu">fmap</span> (\x <span class="ot">-&gt;</span> x <span class="fu">&gt;&gt;=</span> f) z</a></code></pre></div>
<hr />
<p>Let’s write some helper functions:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb29-1" title="1"><span class="ot">writeLine ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> <span class="dt">Teletype</span> ()</a>
<a class="sourceLine" id="cb29-2" title="2">writeLine msg <span class="fu">=</span> <span class="dt">Impure</span> <span class="fu">$</span> <span class="dt">WriteLine</span> msg <span class="fu">$</span> <span class="fu">pure</span> ()</a>
<a class="sourceLine" id="cb29-3" title="3"></a>
<a class="sourceLine" id="cb29-4" title="4"><span class="ot">readLine ::</span> <span class="dt">Free</span> <span class="dt">Teletype</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb29-5" title="5">readLine <span class="fu">=</span> <span class="dt">Impure</span> <span class="fu">$</span> <span class="dt">ReadLine</span> <span class="fu">pure</span></a></code></pre></div>
</div>
<div class="incremental">
<p><code>echo</code> is no longer conspicuous:</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb30-1" title="1"><span class="ot">echo ::</span> <span class="dt">Free</span> <span class="dt">Teletype</span> ()</a>
<a class="sourceLine" id="cb30-2" title="2">echo <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb30-3" title="3">  msg <span class="ot">&lt;-</span> readLine</a>
<a class="sourceLine" id="cb30-4" title="4">  writeLine msg</a></code></pre></div>
<hr />
<p>We can also factor out the evaluation plumbing:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb31-1" title="1">runFree</a>
<a class="sourceLine" id="cb31-2" title="2"><span class="ot">    ::</span> <span class="dt">Monad</span> m</a>
<a class="sourceLine" id="cb31-3" title="3">    <span class="ot">=&gt;</span> (<span class="ot">∀</span> x<span class="fu">.</span> f x <span class="ot">-&gt;</span> m x)</a>
<a class="sourceLine" id="cb31-4" title="4">    <span class="ot">-&gt;</span> <span class="dt">Free</span> f a</a>
<a class="sourceLine" id="cb31-5" title="5">    <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb31-6" title="6">runFree _ (<span class="dt">Pure</span> a)  <span class="fu">=</span> <span class="fu">pure</span> a</a>
<a class="sourceLine" id="cb31-7" title="7">runFree f (<span class="dt">Impure</span> k) <span class="fu">=</span> f k <span class="fu">&gt;&gt;=</span> runFree f</a></code></pre></div>
</div>
<div class="incremental">
<p>Less boilerplate in our interpretation:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb32-1" title="1"><span class="ot">runTeletypeInIO ::</span> <span class="dt">Free</span> <span class="dt">Teletype</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</a>
<a class="sourceLine" id="cb32-2" title="2">runTeletypeInIO <span class="fu">=</span> runFree <span class="fu">$</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb32-3" title="3">  <span class="dt">WriteLine</span> msg k <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb32-4" title="4">    <span class="fu">putStrLn</span> msg</a>
<a class="sourceLine" id="cb32-5" title="5">    <span class="fu">pure</span> k</a>
<a class="sourceLine" id="cb32-6" title="6">  <span class="dt">ReadLine</span> k <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb32-7" title="7">    msg <span class="ot">&lt;-</span> <span class="fu">getLine</span></a>
<a class="sourceLine" id="cb32-8" title="8">    <span class="fu">pure</span> <span class="fu">$</span> k msg</a></code></pre></div>
<hr />
</div>
</div>
<h1 id="combining-multiple-effects">Combining Multiple Effects</h1>
<div class="sourceCode" id="cb33"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb33-1" title="1"><span class="kw">data</span> <span class="dt">Bell</span> k</a>
<a class="sourceLine" id="cb33-2" title="2">  <span class="fu">=</span> <span class="dt">RingBell</span> k</a>
<a class="sourceLine" id="cb33-3" title="3">  <span class="kw">deriving</span> <span class="dt">Functor</span></a></code></pre></div>
<div class="incremental">
<div class="sourceCode" id="cb34"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb34-1" title="1"><span class="kw">data</span> <span class="dt">Sum</span> f g a</a>
<a class="sourceLine" id="cb34-2" title="2">  <span class="fu">=</span> <span class="dt">L</span> (f a)</a>
<a class="sourceLine" id="cb34-3" title="3">  <span class="fu">|</span> <span class="dt">R</span> (g a)</a>
<a class="sourceLine" id="cb34-4" title="4"></a>
<a class="sourceLine" id="cb34-5" title="5"><span class="kw">instance</span> (<span class="dt">Functor</span> f, <span class="dt">Functor</span> g) <span class="ot">=&gt;</span> <span class="dt">Functor</span> (<span class="dt">Sum</span> f g)</a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb35"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb35-1" title="1"><span class="kw">type</span> <span class="dt">TeletypeWithBell</span> <span class="fu">=</span> <span class="dt">Sum</span> <span class="dt">Teletype</span> <span class="dt">Bell</span></a></code></pre></div>
<hr />
<p>Before:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb36-1" title="1"><span class="ot">writeLine ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> <span class="dt">Teletype</span> ()</a>
<a class="sourceLine" id="cb36-2" title="2">writeLine msg <span class="fu">=</span> <span class="dt">Impure</span> <span class="fu">$</span> <span class="dt">WriteLine</span> msg <span class="fu">$</span> <span class="fu">pure</span> ()</a></code></pre></div>
<p>After:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb37-1" title="1"><span class="ot">writeLine ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> <span class="dt">TeletypeWithBell</span> ()</a>
<a class="sourceLine" id="cb37-2" title="2">writeLine msg <span class="fu">=</span> <span class="dt">Impure</span> <span class="fu">$</span> <span class="dt">L</span> <span class="fu">$</span> <span class="dt">WriteLine</span> msg <span class="fu">$</span> <span class="fu">pure</span> ()</a>
<a class="sourceLine" id="cb37-3" title="3"></a>
<a class="sourceLine" id="cb37-4" title="4"><span class="ot">ringBell ::</span> <span class="dt">Free</span> <span class="dt">TeletypeWithBell</span> ()</a>
<a class="sourceLine" id="cb37-5" title="5">ringBell <span class="fu">=</span> <span class="dt">Impure</span> <span class="fu">$</span> <span class="dt">R</span> <span class="fu">$</span> <span class="dt">RingBell</span> <span class="fu">$</span> <span class="fu">pure</span> ()</a></code></pre></div>
<hr />
<p>We can interleave actions from both effects.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb38-1" title="1"><span class="ot">ringItSingIt ::</span> <span class="dt">Free</span> <span class="dt">TeletypeWithBell</span> ()</a>
<a class="sourceLine" id="cb38-2" title="2">ringItSingIt <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb38-3" title="3">  msg <span class="ot">&lt;-</span> readLine</a>
<a class="sourceLine" id="cb38-4" title="4">  when (msg <span class="fu">==</span> <span class="st">&quot;ring the bell!&quot;</span>) ringBell</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb39"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb39-1" title="1">interpret</a>
<a class="sourceLine" id="cb39-2" title="2"><span class="ot">    ::</span> <span class="dt">Monad</span> m</a>
<a class="sourceLine" id="cb39-3" title="3">    <span class="ot">=&gt;</span> (<span class="kw">forall</span> x<span class="fu">.</span> f x <span class="ot">-&gt;</span> m x)</a>
<a class="sourceLine" id="cb39-4" title="4">    <span class="ot">-&gt;</span> (<span class="kw">forall</span> x<span class="fu">.</span> g x <span class="ot">-&gt;</span> m x)</a>
<a class="sourceLine" id="cb39-5" title="5">    <span class="ot">-&gt;</span> <span class="dt">Sum</span> f g a</a>
<a class="sourceLine" id="cb39-6" title="6">    <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb39-7" title="7">interpret hf _ (<span class="dt">L</span> mf) <span class="fu">=</span> hf mf</a>
<a class="sourceLine" id="cb39-8" title="8">interpret _ hg (<span class="dt">R</span> mg) <span class="fu">=</span> hg mg</a></code></pre></div>
</div>
<div class="incremental">
<p>We can nest effects as deeply as we want inside of <code>Sum</code>!</p>
<hr />
</div>
<h1 id="effects-a-la-carte">Effects a la Carte</h1>
<div class="sourceCode" id="cb40"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb40-1" title="1"><span class="kw">data</span> <span class="dt">Union</span> r a</a></code></pre></div>
<div class="incremental">
<p>For example:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb41-1" title="1"><span class="dt">Union</span> &#39;[<span class="dt">Bell</span>, <span class="dt">Teletype</span>, <span class="dt">State</span> <span class="dt">Bool</span>, <span class="dt">Error</span> <span class="dt">InvalidArgument</span>] a</a></code></pre></div>
</div>
<div class="incremental">
<p><code>Union r</code> is a <code>Functor</code> iff every type inside of <code>r</code> is.</p>
<hr />
<p>We can get in and out of a <code>Union</code>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb42-1" title="1"><span class="kw">class</span> <span class="dt">Member</span> f r <span class="kw">where</span></a>
<a class="sourceLine" id="cb42-2" title="2"><span class="ot">  inj  ::</span> f a       <span class="ot">-&gt;</span> <span class="dt">Union</span> r a</a>
<a class="sourceLine" id="cb42-3" title="3"><span class="ot">  proj ::</span> <span class="dt">Union</span> r a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (f a)</a></code></pre></div>
<hr />
<p>Before:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb43-1" title="1"><span class="ot">writeLine ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> <span class="dt">TeletypeWithBell</span> ()</a>
<a class="sourceLine" id="cb43-2" title="2">writeLine msg <span class="fu">=</span> <span class="dt">Impure</span> <span class="fu">$</span> <span class="dt">L</span> <span class="fu">$</span> <span class="dt">WriteLine</span> msg <span class="fu">$</span> <span class="fu">pure</span> ()</a></code></pre></div>
<p>After:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb44-1" title="1"><span class="ot">writeLine ::</span> <span class="dt">Member</span> <span class="dt">Teletype</span> r <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">Union</span> r) ()</a>
<a class="sourceLine" id="cb44-2" title="2">writeLine msg <span class="fu">=</span> <span class="dt">Impure</span> <span class="fu">$</span> inj <span class="fu">$</span> <span class="dt">WriteLine</span> msg <span class="fu">$</span> <span class="fu">pure</span> ()</a></code></pre></div>
</div>
<div class="incremental">
<p>Now we are <strong>polymorphic in our capabilities</strong>.</p>
<hr />
<p>This is where <code>freer-simple</code> and <code>fused-effects</code> start to differ.</p>
</div>
<div class="incremental">
<blockquote>
<p><code>freer-simple</code> diverges to get rid of the boilerplate.</p>
</blockquote>
</div>
<div class="incremental">
<blockquote>
<p><code>fused-effects</code> diverges to get more speed and expressiveness.</p>
</blockquote>
</div>
<div class="incremental">
<p>Unfortunately, it’s unclear how to merge the two differences.</p>
<hr />
</div>
<h1 id="how-does-freer-simple-eliminate-the-boilerplate">How Does <code>freer-simple</code> eliminate the boilerplate?</h1>
<p>Insight: because we can’t embed our effects, we can just keep them in a queue.</p>
<div class="incremental">
<p>Rather than:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb45-1" title="1">echo <span class="fu">=</span> <span class="dt">ReadLine</span> <span class="fu">$</span> \msg <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb45-2" title="2">       <span class="dt">WriteLine</span> msg</a>
<a class="sourceLine" id="cb45-3" title="3">     <span class="fu">$</span> <span class="dt">Done</span> ()</a></code></pre></div>
</div>
<div class="incremental">
<p>we can just write</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb46-1" title="1">echo <span class="fu">=</span> [<span class="dt">ReadLine</span>, <span class="dt">WriteLine</span>]</a></code></pre></div>
</div>
<div class="incremental">
<p>(plus a little magic to thread the output of <code>ReadLine</code> to the input of <code>WriteLine</code>)</p>
<hr />
<p>With this encoding, we no longer need to have continuations in our effects.</p>
</div>
<div class="incremental">
<p>Before:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb47-1" title="1"><span class="kw">data</span> <span class="dt">Teletype</span> a</a>
<a class="sourceLine" id="cb47-2" title="2">  <span class="fu">=</span> <span class="dt">WriteLine</span> <span class="dt">String</span> a</a>
<a class="sourceLine" id="cb47-3" title="3">  <span class="fu">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> a)</a></code></pre></div>
</div>
<div class="incremental">
<p>After:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb48-1" title="1"><span class="kw">data</span> <span class="dt">Teletype</span> a <span class="kw">where</span></a>
<a class="sourceLine" id="cb48-2" title="2">  <span class="dt">WriteLine</span><span class="ot"> ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Teletype</span> ()</a>
<a class="sourceLine" id="cb48-3" title="3">  <span class="dt">ReadLine</span><span class="ot">  ::</span> <span class="dt">Teletype</span> <span class="dt">String</span></a></code></pre></div>
</div>
<div class="incremental">
<blockquote>
<p>Doesn’t require <code>Functor</code> instances</p>
</blockquote>
<blockquote>
<p>Exactly parallels the types of the actions</p>
</blockquote>
<hr />
<p>This is a great change, and is <span class="math inline">\(O(n)\)</span> faster than the naive encoding!</p>
</div>
<div class="incremental">
<p>Unfortunately it has extremely high constant factors, due to needing to allocate the intermediary queue of actions.</p>
<hr />
<h2 id="too-fast-too-free">Too Fast, Too Free</h2>
<p>Two months ago, Li-Yao Xia:</p>
<!-- TODO(sandy): get the real quote! -->
<blockquote>
<p>I bet if you used the final encoding of <code>Freer</code>, it would be much faster.</p>
</blockquote>
<div class="sourceCode" id="cb49"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb49-1" title="1"><span class="kw">newtype</span> <span class="dt">Freer</span> r a <span class="fu">=</span> <span class="dt">Freer</span></a>
<a class="sourceLine" id="cb49-2" title="2">  { runFreer</a>
<a class="sourceLine" id="cb49-3" title="3"><span class="ot">        ::</span> <span class="ot">∀</span> m</a>
<a class="sourceLine" id="cb49-4" title="4">         <span class="fu">.</span> <span class="dt">Monad</span> m</a>
<a class="sourceLine" id="cb49-5" title="5">        <span class="ot">=&gt;</span> (<span class="ot">∀</span> x<span class="fu">.</span> <span class="dt">Union</span> r x <span class="ot">-&gt;</span> m x)</a>
<a class="sourceLine" id="cb49-6" title="6">        <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb49-7" title="7">  }</a></code></pre></div>
<div class="incremental">
<p>What the heck is this thing??</p>
<hr />
<p><code>Free</code> is uniquely determined by its interpretation function:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb50-1" title="1">runFree</a>
<a class="sourceLine" id="cb50-2" title="2"><span class="ot">    ::</span> <span class="dt">Monad</span> m</a>
<a class="sourceLine" id="cb50-3" title="3">    <span class="ot">=&gt;</span> (<span class="ot">∀</span> x<span class="fu">.</span> f x <span class="ot">-&gt;</span> m x)</a>
<a class="sourceLine" id="cb50-4" title="4">    <span class="ot">-&gt;</span> <span class="dt">Free</span> f a</a>
<a class="sourceLine" id="cb50-5" title="5">    <span class="ot">-&gt;</span> m a</a></code></pre></div>
</div>
<div class="incremental">
<p>We can reshuffle the <code>Free</code> argument first, and use this function as our definition of <code>Freer</code>.</p>
<hr />
<p>Reshuffled:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb51-1" title="1">runFree</a>
<a class="sourceLine" id="cb51-2" title="2"><span class="ot">    ::</span> <span class="dt">Free</span> (<span class="dt">Union</span> r) a</a>
<a class="sourceLine" id="cb51-3" title="3">    <span class="ot">-&gt;</span> <span class="ot">∀</span> m</a>
<a class="sourceLine" id="cb51-4" title="4">     <span class="fu">.</span> <span class="dt">Monad</span> m</a>
<a class="sourceLine" id="cb51-5" title="5">    <span class="ot">=&gt;</span> (<span class="ot">∀</span> x<span class="fu">.</span> <span class="dt">Union</span> r x <span class="ot">-&gt;</span> m x)</a>
<a class="sourceLine" id="cb51-6" title="6">    <span class="ot">-&gt;</span> m a</a></code></pre></div>
</div>
<div class="incremental">
<p>Put a newtype constructor around it:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb52-1" title="1"><span class="kw">newtype</span> <span class="dt">Freer</span> r a <span class="fu">=</span> <span class="dt">Freer</span></a>
<a class="sourceLine" id="cb52-2" title="2">  { runFreer</a>
<a class="sourceLine" id="cb52-3" title="3"><span class="ot">        ::</span> <span class="ot">∀</span> m</a>
<a class="sourceLine" id="cb52-4" title="4">         <span class="fu">.</span> <span class="dt">Monad</span> m</a>
<a class="sourceLine" id="cb52-5" title="5">        <span class="ot">=&gt;</span> (<span class="ot">∀</span> x<span class="fu">.</span> <span class="dt">Union</span> r x <span class="ot">-&gt;</span> m x)</a>
<a class="sourceLine" id="cb52-6" title="6">        <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb52-7" title="7">  }</a></code></pre></div>
<hr />
<p>It took me a few days to work through the implications of this encoding.</p>
</div>
<div class="incremental">
<p>To my surprise, it improved the constant factors of <code>freer-simple</code> by 35x.</p>
</div>
<div class="incremental">
<p>But why?</p>
<hr />
<p>Consider the humble <code>ReaderT</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb53-1" title="1"><span class="kw">newtype</span> <span class="dt">ReaderT</span> r m a <span class="fu">=</span> <span class="dt">ReaderT</span></a>
<a class="sourceLine" id="cb53-2" title="2">  {<span class="ot"> runReaderT ::</span> r <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb53-3" title="3">  }</a></code></pre></div>
<p><code>ReaderT</code> lets you read a single, constant value of type <code>r</code>.</p>
</div>
<div class="incremental">
<p>It is a zero-cost abstraction.</p>
<hr />
<p>Anything look familiar?</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb54-1" title="1">runReaderT</a>
<a class="sourceLine" id="cb54-2" title="2"><span class="ot">    ::</span> <span class="dt">Monad</span> m</a>
<a class="sourceLine" id="cb54-3" title="3">    <span class="ot">=&gt;</span> <span class="dt">ReaderT</span> r m a</a>
<a class="sourceLine" id="cb54-4" title="4">    <span class="ot">-&gt;</span> r</a>
<a class="sourceLine" id="cb54-5" title="5">    <span class="ot">-&gt;</span> m a</a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb55"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb55-1" title="1">runFreer</a>
<a class="sourceLine" id="cb55-2" title="2"><span class="ot">    ::</span> <span class="dt">Monad</span> m</a>
<a class="sourceLine" id="cb55-3" title="3">    <span class="ot">=&gt;</span> <span class="dt">Freer</span> r a</a>
<a class="sourceLine" id="cb55-4" title="4">    <span class="ot">=&gt;</span> (<span class="ot">∀</span> x<span class="fu">.</span> <span class="dt">Union</span> r x <span class="ot">-&gt;</span> m x)</a>
<a class="sourceLine" id="cb55-5" title="5">    <span class="ot">-&gt;</span> m a</a></code></pre></div>
</div>
<div class="incremental">
<p><strong><code>Freer</code> is just <code>ReaderT</code> in disguise!</strong></p>
<hr />
<p>The proof:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb56-1" title="1"><span class="kw">instance</span> <span class="dt">Monad</span> (<span class="dt">Freer</span> f) <span class="kw">where</span></a>
<a class="sourceLine" id="cb56-2" title="2">  <span class="fu">return</span> a <span class="fu">=</span> <span class="dt">Freer</span> <span class="fu">$</span> \nt <span class="ot">-&gt;</span> <span class="fu">pure</span> a</a>
<a class="sourceLine" id="cb56-3" title="3">  m <span class="fu">&gt;&gt;=</span> f  <span class="fu">=</span> <span class="dt">Freer</span> <span class="fu">$</span> \nt <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb56-4" title="4">    a <span class="ot">&lt;-</span> runFreer m nt</a>
<a class="sourceLine" id="cb56-5" title="5">    runFreer (f a) nt</a>
<a class="sourceLine" id="cb56-6" title="6"></a>
<a class="sourceLine" id="cb56-7" title="7"><span class="kw">instance</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">ReaderT</span> r m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb56-8" title="8">  <span class="fu">return</span> a <span class="fu">=</span> <span class="dt">ReaderT</span> <span class="fu">$</span> \r <span class="ot">-&gt;</span> <span class="fu">pure</span> a</a>
<a class="sourceLine" id="cb56-9" title="9">  m <span class="fu">&gt;&gt;=</span> f  <span class="fu">=</span> <span class="dt">ReaderT</span> <span class="fu">$</span> \r <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb56-10" title="10">    a <span class="ot">&lt;-</span> runReaderT m r</a>
<a class="sourceLine" id="cb56-11" title="11">    runReaderT (f a) r</a></code></pre></div>
<p>Identical <code>Monad</code> instances!</p>
<hr />
<p>We can use the natural transformation to make effects zero cost.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb57"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb57-1" title="1"><span class="ot">liftFreer ::</span> <span class="dt">Member</span> f r <span class="ot">=&gt;</span> f a <span class="ot">-&gt;</span> <span class="dt">Freer</span> r a</a>
<a class="sourceLine" id="cb57-2" title="2">liftFreer fa <span class="fu">=</span> <span class="dt">Freer</span> <span class="fu">$</span> \nt <span class="ot">-&gt;</span> nt <span class="fu">$</span> inj fa</a></code></pre></div>
</div>
<div class="incremental">
<p>Now:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb58-1" title="1"><span class="ot">writeLine&#39; ::</span> <span class="dt">Member</span> <span class="dt">Teletype</span> r <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Freer</span> r ()</a>
<a class="sourceLine" id="cb58-2" title="2">writeLine&#39; msg <span class="fu">=</span> liftFreer <span class="fu">$</span> <span class="dt">WriteLine</span> msg</a></code></pre></div>
<hr />
<p>What the heck is going on?</p>
<p>Now any time our free monad wants to use an action, it immediately runs it in the final monad.</p>
<hr />
</div>
</div>
<h1 id="even-freer-freer-monads">Even freer freer monads</h1>
<div class="sourceCode" id="cb59"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb59-1" title="1"><span class="ot">echo ::</span> <span class="dt">Member</span> <span class="dt">Teletype</span> r <span class="ot">=&gt;</span> <span class="dt">Freer</span> r ()</a>
<a class="sourceLine" id="cb59-2" title="2">echo <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb59-3" title="3">  msg <span class="ot">&lt;-</span> readLine</a>
<a class="sourceLine" id="cb59-4" title="4">  writeLine msg</a>
<a class="sourceLine" id="cb59-5" title="5"></a>
<a class="sourceLine" id="cb59-6" title="6"><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb59-7" title="7">echoIO <span class="fu">=</span> runFreer runTeletypeInIO echo</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb60"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb60-1" title="1"><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb60-2" title="2">echoIO <span class="fu">=</span> runFreer runTeletypeInIO echo</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb61"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb61-1" title="1"><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb61-2" title="2">echoIO <span class="fu">=</span> runFreer runTeletypeInIO <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb61-3" title="3">  msg <span class="ot">&lt;-</span> readLine</a>
<a class="sourceLine" id="cb61-4" title="4">  writeLine msg</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb62"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb62-1" title="1"><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb62-2" title="2">echoIO <span class="fu">=</span> runFreer runTeletypeInIO <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb62-3" title="3">  msg <span class="ot">&lt;-</span> liftFreer <span class="dt">ReadLine</span></a>
<a class="sourceLine" id="cb62-4" title="4">  liftFreer <span class="fu">$</span> <span class="dt">WriteLine</span> msg</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb63"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb63-1" title="1"><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb63-2" title="2">echoIO <span class="fu">=</span> runFreer runTeletypeInIO <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb63-3" title="3">  msg <span class="ot">&lt;-</span> <span class="dt">Freer</span> <span class="fu">$</span> \nt <span class="ot">-&gt;</span> nt <span class="dt">ReadLine</span></a>
<a class="sourceLine" id="cb63-4" title="4">  <span class="dt">Freer</span> <span class="fu">$</span> \nt <span class="ot">-&gt;</span> nt <span class="fu">$</span> <span class="dt">WriteLine</span> msg</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb64"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb64-1" title="1"><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb64-2" title="2">echoIO <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb64-3" title="3">  msg <span class="ot">&lt;-</span> runTeletypeInIO <span class="dt">ReadLine</span></a>
<a class="sourceLine" id="cb64-4" title="4">  runTeletypeInIO <span class="fu">$</span> <span class="dt">WriteLine</span> msg</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb65"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb65-1" title="1"><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb65-2" title="2">echoIO <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb65-3" title="3">  msg <span class="ot">&lt;-</span> <span class="kw">case</span> <span class="dt">ReadLine</span> <span class="kw">of</span></a>
<a class="sourceLine" id="cb65-4" title="4">           <span class="dt">ReadLine</span>    <span class="ot">-&gt;</span> <span class="fu">getLine</span></a>
<a class="sourceLine" id="cb65-5" title="5">           <span class="dt">WriteLine</span> s <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> s</a>
<a class="sourceLine" id="cb65-6" title="6">  <span class="kw">case</span> <span class="dt">WriteLine</span> msg <span class="kw">of</span></a>
<a class="sourceLine" id="cb65-7" title="7">    <span class="dt">ReadLine</span>    <span class="ot">-&gt;</span> <span class="fu">getLine</span></a>
<a class="sourceLine" id="cb65-8" title="8">    <span class="dt">WriteLine</span> s <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> s</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb66"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb66-1" title="1"><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb66-2" title="2">echoIO <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb66-3" title="3">  msg <span class="ot">&lt;-</span> <span class="kw">case</span> <span class="dt">ReadLine</span> <span class="kw">of</span></a>
<a class="sourceLine" id="cb66-4" title="4">           <span class="dt">ReadLine</span>    <span class="ot">-&gt;</span> <span class="fu">getLine</span></a>
<a class="sourceLine" id="cb66-5" title="5">           <span class="co">-- WriteLine s -&gt; putStrLn msg</span></a>
<a class="sourceLine" id="cb66-6" title="6">  <span class="kw">case</span> <span class="dt">WriteLine</span> msg <span class="kw">of</span></a>
<a class="sourceLine" id="cb66-7" title="7">    <span class="co">-- ReadLine    -&gt; getLine</span></a>
<a class="sourceLine" id="cb66-8" title="8">    <span class="dt">WriteLine</span> s <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> s</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb67"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb67-1" title="1"><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb67-2" title="2">echoIO <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb67-3" title="3">  msg <span class="ot">&lt;-</span> <span class="kw">case</span> <span class="dt">ReadLine</span> <span class="kw">of</span></a>
<a class="sourceLine" id="cb67-4" title="4">           <span class="dt">ReadLine</span> <span class="ot">-&gt;</span> <span class="fu">getLine</span></a>
<a class="sourceLine" id="cb67-5" title="5">  <span class="kw">case</span> <span class="dt">WriteLine</span> msg <span class="kw">of</span></a>
<a class="sourceLine" id="cb67-6" title="6">    <span class="dt">WriteLine</span> s <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> s</a></code></pre></div>
<hr />
<div class="sourceCode" id="cb68"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb68-1" title="1"><span class="ot">echoIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb68-2" title="2">echoIO <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb68-3" title="3">  msg <span class="ot">&lt;-</span> <span class="fu">getLine</span></a>
<a class="sourceLine" id="cb68-4" title="4">  <span class="fu">putStrLn</span> msg</a></code></pre></div>
<div class="incremental">
<p>So free!</p>
<hr />
<p>We’ve now shown how to solve the boilerplate and performance problems.</p>
</div>
<div class="incremental">
<h2 id="lets-rewind-and-look-at-the-changes-fused-effects-makes.">Lets rewind and look at the changes <code>fused-effects</code> makes.</h2>
<hr />
</div>
<h1 id="down-the-other-trouser-where-we-left-off">Down the other trouser (where we left off)</h1>
<div class="sourceCode" id="cb69"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb69-1" title="1"><span class="kw">data</span> <span class="dt">Free</span> r k</a>
<a class="sourceLine" id="cb69-2" title="2">  <span class="fu">=</span> <span class="dt">Pure</span> k</a>
<a class="sourceLine" id="cb69-3" title="3">  <span class="fu">|</span> <span class="dt">Impure</span> (<span class="dt">Union</span> r (<span class="dt">Free</span> r k))</a>
<a class="sourceLine" id="cb69-4" title="4"></a>
<a class="sourceLine" id="cb69-5" title="5"></a>
<a class="sourceLine" id="cb69-6" title="6"><span class="kw">data</span> <span class="dt">Teletype</span> a</a>
<a class="sourceLine" id="cb69-7" title="7">  <span class="fu">=</span> <span class="dt">WriteLine</span> <span class="dt">String</span> a</a>
<a class="sourceLine" id="cb69-8" title="8">  <span class="fu">|</span> <span class="dt">ReadLine</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> a)</a>
<a class="sourceLine" id="cb69-9" title="9">  <span class="kw">deriving</span> <span class="dt">Functor</span></a>
<a class="sourceLine" id="cb69-10" title="10"></a>
<a class="sourceLine" id="cb69-11" title="11"></a>
<a class="sourceLine" id="cb69-12" title="12"><span class="ot">writeLine ::</span> <span class="dt">Member</span> <span class="dt">Teletype</span> r <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Free</span> r ()</a>
<a class="sourceLine" id="cb69-13" title="13">writeLine msg <span class="fu">=</span> <span class="dt">Impure</span> <span class="fu">$</span> inj <span class="fu">$</span> <span class="dt">WriteLine</span> msg <span class="fu">$</span> <span class="fu">pure</span> ()</a></code></pre></div>
<hr />
<p>An effect we’d like, but can’t have:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb70-1" title="1">throw</a>
<a class="sourceLine" id="cb70-2" title="2"><span class="ot">    ::</span> <span class="dt">Member</span> (<span class="dt">Error</span> e) r</a>
<a class="sourceLine" id="cb70-3" title="3">    <span class="ot">=&gt;</span> e</a>
<a class="sourceLine" id="cb70-4" title="4">    <span class="ot">-&gt;</span> <span class="dt">Free</span> r a</a>
<a class="sourceLine" id="cb70-5" title="5"></a>
<a class="sourceLine" id="cb70-6" title="6"><span class="fu">catch</span></a>
<a class="sourceLine" id="cb70-7" title="7"><span class="ot">    ::</span> <span class="dt">Member</span> (<span class="dt">Error</span> e) r</a>
<a class="sourceLine" id="cb70-8" title="8">    <span class="ot">=&gt;</span> <span class="dt">Free</span> r a</a>
<a class="sourceLine" id="cb70-9" title="9">    <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> <span class="dt">Free</span> r a)</a>
<a class="sourceLine" id="cb70-10" title="10">    <span class="ot">-&gt;</span> <span class="dt">Free</span> r a</a></code></pre></div>
<p><code>catch</code> contains an embedded <code>Free</code>.</p>
<hr />
<p>What we’d like:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb71-1" title="1"><span class="kw">data</span> <span class="dt">Error</span> e k</a>
<a class="sourceLine" id="cb71-2" title="2">  <span class="fu">=</span> <span class="dt">Throw</span> e</a>
<a class="sourceLine" id="cb71-3" title="3">  <span class="fu">|</span> <span class="ot">∀</span> x<span class="fu">.</span> <span class="dt">Catch</span> (<span class="fu">???</span>)</a>
<a class="sourceLine" id="cb71-4" title="4">               (e <span class="ot">-&gt;</span> <span class="fu">???</span>)</a>
<a class="sourceLine" id="cb71-5" title="5">               (x <span class="ot">-&gt;</span> k)</a></code></pre></div>
<hr />
<p>Maybe</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb72-1" title="1"><span class="kw">data</span> <span class="dt">Error</span> e r k</a>
<a class="sourceLine" id="cb72-2" title="2">  <span class="fu">=</span> <span class="dt">Throw</span> e</a>
<a class="sourceLine" id="cb72-3" title="3">  <span class="fu">|</span> <span class="ot">∀</span> x<span class="fu">.</span> <span class="dt">Catch</span> (<span class="dt">Free</span> r x)</a>
<a class="sourceLine" id="cb72-4" title="4">               (e <span class="ot">-&gt;</span> <span class="dt">Free</span> r x)</a>
<a class="sourceLine" id="cb72-5" title="5">               (x <span class="ot">-&gt;</span> k)</a></code></pre></div>
<p>?</p>
<div class="incremental">
<p>Unfortunately this type cannot be embedded inside a <code>Union</code> :(</p>
<hr />
<p>Instead:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb73-1" title="1"><span class="kw">data</span> <span class="dt">Error</span> e m k</a>
<a class="sourceLine" id="cb73-2" title="2">  <span class="fu">=</span> <span class="dt">Throw</span> e</a>
<a class="sourceLine" id="cb73-3" title="3">  <span class="fu">|</span> <span class="ot">∀</span> x<span class="fu">.</span> <span class="dt">Catch</span> (m x)</a>
<a class="sourceLine" id="cb73-4" title="4">               (e <span class="ot">-&gt;</span> m x)</a>
<a class="sourceLine" id="cb73-5" title="5">               (x <span class="ot">-&gt;</span> k)</a></code></pre></div>
</div>
<div class="incremental">
<p>Just force <code>m</code> to be <code>Free r</code>:</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb74"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb74-1" title="1"><span class="kw">data</span> <span class="dt">Free</span> r a</a>
<a class="sourceLine" id="cb74-2" title="2">  <span class="fu">=</span> <span class="dt">Pure</span> a</a>
<a class="sourceLine" id="cb74-3" title="3">  <span class="fu">|</span> <span class="dt">Impure</span> (<span class="dt">Union</span> r (<span class="dt">Free</span> r) a)</a>
<a class="sourceLine" id="cb74-4" title="4"></a>
<a class="sourceLine" id="cb74-5" title="5"><span class="ot">liftFree ::</span> <span class="dt">Member</span> f r <span class="ot">=&gt;</span> f (<span class="dt">Free</span> r) (<span class="dt">Free</span> r a) <span class="ot">-&gt;</span> <span class="dt">Free</span> r a</a></code></pre></div>
<hr />
<p>Effects don’t need to use <code>m</code> if they don’t want to.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb75-1" title="1"><span class="kw">data</span> <span class="dt">State</span> s m k</a>
<a class="sourceLine" id="cb75-2" title="2">  <span class="fu">=</span> <span class="dt">Get</span> (s <span class="ot">-&gt;</span> k)</a>
<a class="sourceLine" id="cb75-3" title="3">  <span class="fu">|</span> <span class="dt">Put</span> s k</a></code></pre></div>
<hr />
<h2 id="the-problem">The Problem</h2>
<p>How do <code>State</code> and <code>Error</code> interact?</p>
<div class="incremental">
<p>How can we thread state changes through a <code>Catch</code> action?</p>
<hr />
</div>
<h2 id="the-solution-functors">The Solution: Functors!</h2>
<div class="incremental">
<p>What is a functor, really?</p>
</div>
<div class="incremental">
<p>Just a value in some sort of context.</p>
</div>
<div class="incremental">
<p>In particular, a value of <code>f ()</code> is <em>only</em> a context!</p>
<hr />
<p>We can abuse this fact, and wrap up the state of the world as some functor.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb76"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb76-1" title="1"><span class="kw">class</span> <span class="dt">Effect</span> e <span class="kw">where</span></a>
<a class="sourceLine" id="cb76-2" title="2"><span class="ot">  weave ::</span> <span class="dt">Functor</span> tk</a>
<a class="sourceLine" id="cb76-3" title="3">        <span class="ot">=&gt;</span> tk ()</a>
<a class="sourceLine" id="cb76-4" title="4">        <span class="ot">-&gt;</span> (<span class="ot">∀</span> x<span class="fu">.</span> tk (m x) <span class="ot">-&gt;</span> n (tk x))</a>
<a class="sourceLine" id="cb76-5" title="5">        <span class="ot">-&gt;</span> e m a</a>
<a class="sourceLine" id="cb76-6" title="6">        <span class="ot">-&gt;</span> e n (tk a)</a></code></pre></div>
</div>
<div class="incremental">
<ul>
<li><p><code>tk ()</code> is the state of the world when the effect starts</p></li>
<li><p><code>(∀ x. tk (m x) -&gt; n (tk x))</code> is a distribution law for describing how to run effects in a context.</p></li>
</ul>
</div>
<div class="incremental">
<p><code>weave</code> allows an effect to have other effects “pushed through it.”</p>
<hr />
<p>Weaving through <code>Error</code>:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb77-1" title="1"><span class="kw">instance</span> <span class="dt">Effect</span> (<span class="dt">Error</span> e) <span class="kw">where</span></a>
<a class="sourceLine" id="cb77-2" title="2">  weave _ _ (<span class="dt">Throw</span> e) <span class="fu">=</span> <span class="dt">Throw</span> e</a>
<a class="sourceLine" id="cb77-3" title="3">  weave tk distrib (<span class="dt">Catch</span> try handle k) <span class="fu">=</span></a>
<a class="sourceLine" id="cb77-4" title="4">    <span class="dt">Catch</span> (distrib <span class="fu">$</span> try <span class="fu">&lt;$</span> tk)</a>
<a class="sourceLine" id="cb77-5" title="5">          (\e <span class="ot">-&gt;</span> distrib <span class="fu">$</span> handle e <span class="fu">&lt;$</span> tk)</a>
<a class="sourceLine" id="cb77-6" title="6">          (<span class="fu">fmap</span> k)</a></code></pre></div>
</div>
<div class="incremental">
<p>The “ice-cream cone” operator replaces the contents of a <code>Functor</code>:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb78-1" title="1"><span class="ot">(&lt;$) ::</span> <span class="dt">Functor</span> f <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> f b <span class="ot">-&gt;</span> f a</a></code></pre></div>
<hr />
<p>The <code>State</code> effect needs to push its state through other effects’ subcomputations.</p>
<p>It can call <code>weave</code> to do this.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb79"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb79-1" title="1"><span class="ot">runState ::</span> s <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">State</span> s &#39;<span class="fu">:</span> r) a <span class="ot">-&gt;</span> <span class="dt">Free</span> r (s, a)</a>
<a class="sourceLine" id="cb79-2" title="2">runState s (<span class="dt">Pure</span> a) <span class="fu">=</span> <span class="fu">pure</span> (s, a)</a>
<a class="sourceLine" id="cb79-3" title="3">runState s (<span class="dt">Impure</span> u) <span class="fu">=</span></a>
<a class="sourceLine" id="cb79-4" title="4">  <span class="kw">case</span> decomp u <span class="kw">of</span></a>
<a class="sourceLine" id="cb79-5" title="5">    <span class="dt">Left</span> other <span class="ot">-&gt;</span> <span class="dt">Impure</span> <span class="fu">$</span></a>
<a class="sourceLine" id="cb79-6" title="6">      weave (s, ())</a>
<a class="sourceLine" id="cb79-7" title="7">            (\(s&#39;, m) <span class="ot">-&gt;</span> runState s&#39; m)</a>
<a class="sourceLine" id="cb79-8" title="8">            other</a>
<a class="sourceLine" id="cb79-9" title="9">    <span class="dt">Right</span> (<span class="dt">Get</span> k)    <span class="ot">-&gt;</span> <span class="fu">pure</span> (s,  k s)</a>
<a class="sourceLine" id="cb79-10" title="10">    <span class="dt">Right</span> (<span class="dt">Put</span> s&#39; k) <span class="ot">-&gt;</span> <span class="fu">pure</span> (s&#39;, k)</a></code></pre></div>
</div>
<div class="incremental">
<p><code>decomp</code> can extract a single effect out of a <code>Union</code>; or prove that it was never there to begin with.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb80"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb80-1" title="1">decomp</a>
<a class="sourceLine" id="cb80-2" title="2"><span class="ot">    ::</span> <span class="dt">Union</span> (e &#39;<span class="fu">:</span> r) m a</a>
<a class="sourceLine" id="cb80-3" title="3">    <span class="ot">-&gt;</span> <span class="dt">Either</span> (<span class="dt">Union</span> r m a) (e m a)</a></code></pre></div>
<hr />
<p>Surprisingly, this thing works!</p>
</div>
<div class="incremental">
<p>But it’s slow.</p>
</div>
<div class="incremental">
<p>Because <code>runState</code> is recursive, GHC won’t perform any optimizations on it :(</p>
<hr />
<p>We can “break the recursion” by hand.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb81-1" title="1"><span class="ot">runState ::</span> s <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">State</span> s &#39;<span class="fu">:</span> r) a <span class="ot">-&gt;</span> <span class="dt">Free</span> r (s, a)</a>
<a class="sourceLine" id="cb81-2" title="2">runState s (<span class="dt">Pure</span> a) <span class="fu">=</span> <span class="fu">pure</span> (s, a)</a>
<a class="sourceLine" id="cb81-3" title="3">runState s (<span class="dt">Impure</span> u) <span class="fu">=</span></a>
<a class="sourceLine" id="cb81-4" title="4">  <span class="kw">case</span> decomp u <span class="kw">of</span></a>
<a class="sourceLine" id="cb81-5" title="5">    <span class="dt">Left</span> other <span class="ot">-&gt;</span> <span class="dt">Impure</span> <span class="fu">$</span></a>
<a class="sourceLine" id="cb81-6" title="6">      weave (s, ())</a>
<a class="sourceLine" id="cb81-7" title="7">            (\(s, m) <span class="ot">-&gt;</span> runState_b s m)</a>
<a class="sourceLine" id="cb81-8" title="8">            other</a>
<a class="sourceLine" id="cb81-9" title="9">    <span class="dt">Right</span> (<span class="dt">Get</span> k)    <span class="ot">-&gt;</span> <span class="fu">pure</span> (s,  k s)</a>
<a class="sourceLine" id="cb81-10" title="10">    <span class="dt">Right</span> (<span class="dt">Put</span> s k) <span class="ot">-&gt;</span> <span class="fu">pure</span> (s, k)</a>
<a class="sourceLine" id="cb81-11" title="11"><span class="ot">{-# INLINE runState #-}</span></a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb82"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb82-1" title="1"><span class="ot">runState_b ::</span> s <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">State</span> s &#39;<span class="fu">:</span> r) a <span class="ot">-&gt;</span> <span class="dt">Free</span> r (s, a)</a>
<a class="sourceLine" id="cb82-2" title="2">runState_b <span class="fu">=</span> runState</a>
<a class="sourceLine" id="cb82-3" title="3"><span class="ot">{-# NOINLINE runState_b #-}</span></a></code></pre></div>
</div>
<div class="incremental">
<p>Now GHC is happy and will make our program <strong>fast</strong>!</p>
<hr />
<p>Lots of the boilerplate in <code>fused-effects</code> comes from needing to write <code>Effect</code> instances.</p>
</div>
<div class="incremental">
<p>But these instances are necessary for higher-order effects!</p>
</div>
<div class="incremental">
<p>Are we cursed to always have this boilerplate?</p>
<hr />
<p>No!</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb83"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb83-1" title="1"><span class="kw">data</span> <span class="dt">Yo</span> e m a <span class="kw">where</span></a>
<a class="sourceLine" id="cb83-2" title="2">  <span class="dt">Yo</span><span class="ot"> ::</span> <span class="dt">Functor</span> tk</a>
<a class="sourceLine" id="cb83-3" title="3">     <span class="ot">=&gt;</span> e m a</a>
<a class="sourceLine" id="cb83-4" title="4">     <span class="ot">-&gt;</span> tk ()</a>
<a class="sourceLine" id="cb83-5" title="5">     <span class="ot">-&gt;</span> (<span class="kw">forall</span> x<span class="fu">.</span> tk (m x) <span class="ot">-&gt;</span> n (tk x))</a>
<a class="sourceLine" id="cb83-6" title="6">     <span class="ot">-&gt;</span> (tk a <span class="ot">-&gt;</span> b)</a>
<a class="sourceLine" id="cb83-7" title="7">     <span class="ot">-&gt;</span> <span class="dt">Yo</span> e n b</a></code></pre></div>
<p><code>Yo</code> is the free <code>Effect</code>!</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb84"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb84-1" title="1"><span class="kw">instance</span> <span class="dt">Effect</span> (<span class="dt">Yo</span> e) <span class="kw">where</span></a>
<a class="sourceLine" id="cb84-2" title="2">  weave tk&#39; distrib&#39; (<span class="dt">Yo</span> e tk distrib f) <span class="fu">=</span></a>
<a class="sourceLine" id="cb84-3" title="3">    <span class="dt">Yo</span> e (<span class="dt">Compose</span> <span class="fu">$</span> tk <span class="fu">&lt;$</span> tk&#39;)</a>
<a class="sourceLine" id="cb84-4" title="4">         (<span class="fu">fmap</span> <span class="dt">Compose</span> <span class="fu">.</span> distrib&#39; <span class="fu">.</span> <span class="fu">fmap</span> distrib <span class="fu">.</span> getCompose)</a>
<a class="sourceLine" id="cb84-5" title="5">         (<span class="fu">fmap</span> f <span class="fu">.</span> getCompose)</a></code></pre></div>
<hr />
<p>And we can get into a <code>Yo</code> by using an <code>Identity</code> functor as our initial state.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb85-1" title="1"><span class="ot">liftYo ::</span> <span class="dt">Functor</span> m <span class="ot">=&gt;</span> e m a <span class="ot">-&gt;</span> <span class="dt">Yo</span> e m a</a>
<a class="sourceLine" id="cb85-2" title="2">liftYo e <span class="fu">=</span> <span class="dt">Yo</span> e (<span class="dt">Identity</span> ())</a>
<a class="sourceLine" id="cb85-3" title="3">                (<span class="fu">fmap</span> <span class="dt">Identity</span> <span class="fu">.</span> runIdentity)</a>
<a class="sourceLine" id="cb85-4" title="4">                runIdentity</a></code></pre></div>
<hr />
<p>Somewhat amazingly, this works!</p>
</div>
<div class="incremental">
<p>But all it means is we’ve delayed giving a meaning for <code>Effect</code> until we need to interpret it.</p>
<hr />
<p>A problem:</p>
<p>The type of <code>runFree</code> doesn’t allow us to change the return type.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb86-1" title="1">runFree</a>
<a class="sourceLine" id="cb86-2" title="2"><span class="ot">    ::</span> <span class="ot">∀</span> m<span class="fu">.</span> <span class="dt">Monad</span> m</a>
<a class="sourceLine" id="cb86-3" title="3">    <span class="ot">=&gt;</span> <span class="dt">Free</span> r a</a>
<a class="sourceLine" id="cb86-4" title="4">    <span class="ot">-&gt;</span> (<span class="ot">∀</span> x<span class="fu">.</span> <span class="dt">Union</span> r (<span class="dt">Free</span> r) x <span class="ot">-&gt;</span> m x)</a>
<a class="sourceLine" id="cb86-5" title="5">    <span class="ot">-&gt;</span> m a</a></code></pre></div>
</div>
<div class="incremental">
<p>It seems like maybe we could just stick a functor in here.</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb87"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb87-1" title="1">runFree</a>
<a class="sourceLine" id="cb87-2" title="2"><span class="ot">    ::</span> <span class="ot">∀</span> m tk<span class="fu">.</span> (<span class="dt">Monad</span> m, <span class="dt">Functor</span> tk)</a>
<a class="sourceLine" id="cb87-3" title="3">    <span class="ot">=&gt;</span> <span class="dt">Free</span> r a</a>
<a class="sourceLine" id="cb87-4" title="4">    <span class="ot">-&gt;</span> (<span class="ot">∀</span> x<span class="fu">.</span> <span class="dt">Union</span> r (<span class="dt">Freer</span> r) x <span class="ot">-&gt;</span> m (tk x))</a>
<a class="sourceLine" id="cb87-5" title="5">    <span class="ot">-&gt;</span> m (tk a)</a></code></pre></div>
</div>
<div class="incremental">
<p><strong>Unfortunately this is no longer a <code>Monad</code>!</strong></p>
<hr />
<p>Recall that we’re allowed to pick <em>any</em> <code>Monad</code> for the result of <code>runFree</code>.</p>
<p>Instead of evaluating to the final monad <code>m</code>…</p>
<hr />
<p>Just transform it into <code>StateT s m</code> and immediately evaluate <em>that</em>!</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb88"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb88-1" title="1"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Control.Monad.Trans.State</span> <span class="kw">as</span> <span class="dt">S</span></a>
<a class="sourceLine" id="cb88-2" title="2"></a>
<a class="sourceLine" id="cb88-3" title="3">runState</a>
<a class="sourceLine" id="cb88-4" title="4"><span class="ot">    ::</span> s</a>
<a class="sourceLine" id="cb88-5" title="5">    <span class="ot">-&gt;</span> <span class="dt">Free</span> (e &#39;<span class="fu">:</span> r) a</a>
<a class="sourceLine" id="cb88-6" title="6">    <span class="ot">-&gt;</span> <span class="dt">Free</span> r (s, a)</a>
<a class="sourceLine" id="cb88-7" title="7">runState s (<span class="dt">Free</span> m) <span class="fu">=</span> <span class="dt">Free</span> <span class="fu">$</span> \nt <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb88-8" title="8">  S.runStateT s <span class="fu">$</span> m <span class="fu">$</span> \u <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb88-9" title="9">    <span class="kw">case</span> decomp u <span class="kw">of</span></a>
<a class="sourceLine" id="cb88-10" title="10">      <span class="dt">Left</span> x <span class="ot">-&gt;</span> <span class="dt">S.StateT</span> <span class="fu">$</span> \s&#39; <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb88-11" title="11">        nt <span class="fu">.</span> weave (s&#39;, ()) (<span class="fu">uncurry</span> <span class="fu">$</span> runState f)</a>
<a class="sourceLine" id="cb88-12" title="12">           <span class="fu">$</span> x</a>
<a class="sourceLine" id="cb88-13" title="13">      <span class="dt">Right</span> (<span class="dt">Yo</span> <span class="dt">Get</span> _ f)      <span class="ot">-&gt;</span> <span class="fu">fmap</span> f <span class="fu">$</span> S.get</a>
<a class="sourceLine" id="cb88-14" title="14">      <span class="dt">Right</span> (<span class="dt">Yo</span> (<span class="dt">Put</span> s&#39;) _ f) <span class="ot">-&gt;</span> <span class="fu">fmap</span> f <span class="fu">$</span> S.put s&#39;</a></code></pre></div>
<hr />
<p>We’ve solved all of the problems! We now have solutions for</p>
<ul>
<li><em>performance</em></li>
<li><em>expressiveness</em></li>
<li><em>boilerplate</em></li>
</ul>
<p>all of which work together!</p>
</div>
<div class="incremental">
<p>But what we’ve built isn’t yet a joyful experience.</p>
</div>
<div class="incremental">
<p>In particular, dealing with <code>Yo</code> is painful.</p>
<hr />
<p>We can clean up the mess of writing effect handlers…</p>
</div>
<div class="incremental">
<p>…</p>
</div>
<div class="incremental">
<p>…with an effect-handler effect!</p>
<hr />
<p>Instead of this:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb89-1" title="1"><span class="kw">instance</span> <span class="dt">Effect</span> (<span class="dt">Error</span> e) <span class="kw">where</span></a>
<a class="sourceLine" id="cb89-2" title="2">  weave _ _ (<span class="dt">Throw</span> e) <span class="fu">=</span> <span class="dt">Throw</span> e</a>
<a class="sourceLine" id="cb89-3" title="3">  weave tk distrib (<span class="dt">Catch</span> try handle k) <span class="fu">=</span></a>
<a class="sourceLine" id="cb89-4" title="4">    <span class="dt">Catch</span> (distrib <span class="fu">$</span> try <span class="fu">&lt;$</span> tk)</a>
<a class="sourceLine" id="cb89-5" title="5">          (\e <span class="ot">-&gt;</span> distrib <span class="fu">$</span> handle e <span class="fu">&lt;$</span> tk)</a>
<a class="sourceLine" id="cb89-6" title="6">          (<span class="fu">fmap</span> k)</a></code></pre></div>
<hr />
<p>We can just write this:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb90-1" title="1">runError <span class="fu">=</span> interpretH <span class="fu">$</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb90-2" title="2">  <span class="dt">Catch</span> try handle <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb90-3" title="3">    t <span class="ot">&lt;-</span> runT try</a>
<a class="sourceLine" id="cb90-4" title="4">    tried <span class="ot">&lt;-</span> runError t</a>
<a class="sourceLine" id="cb90-5" title="5">    <span class="kw">case</span> tried <span class="kw">of</span></a>
<a class="sourceLine" id="cb90-6" title="6">      <span class="dt">Right</span> a <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="fu">$</span> <span class="dt">Right</span> a</a>
<a class="sourceLine" id="cb90-7" title="7">      <span class="dt">Left</span> e <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb90-8" title="8">        h <span class="ot">&lt;-</span> bindT handle</a>
<a class="sourceLine" id="cb90-9" title="9">        handled <span class="ot">&lt;-</span> h e</a>
<a class="sourceLine" id="cb90-10" title="10">        <span class="kw">case</span> handled <span class="kw">of</span></a>
<a class="sourceLine" id="cb90-11" title="11">          <span class="dt">Right</span> a <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="fu">$</span> <span class="dt">Right</span> a</a>
<a class="sourceLine" id="cb90-12" title="12">          <span class="dt">Left</span> e2 <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="fu">$</span> <span class="dt">Left</span> e2</a></code></pre></div>
<p>The magic is in <code>runT</code> and <code>bindT</code>.</p>
<hr />
<p>These combinators come from the <code>Tactics</code> effect:</p>
</div>
<div class="incremental">
<div class="sourceCode" id="cb91"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb91-1" title="1"><span class="kw">data</span> <span class="dt">Tactics</span> tk n r m a <span class="kw">where</span></a>
<a class="sourceLine" id="cb91-2" title="2">  <span class="dt">GetInitialState</span><span class="ot">     ::</span> <span class="dt">Tactics</span> tk n r m (tk ())</a>
<a class="sourceLine" id="cb91-3" title="3">  <span class="dt">HoistInterpretation</span><span class="ot"> ::</span> (a <span class="ot">-&gt;</span> n b)</a>
<a class="sourceLine" id="cb91-4" title="4">                      <span class="ot">-&gt;</span> <span class="dt">Tactics</span> tk n r m (tk a <span class="ot">-&gt;</span> <span class="dt">Free</span> r (tk b))</a></code></pre></div>
</div>
<div class="incremental">
<ul>
<li><code>GetInitialState</code> is the <code>tk ()</code> parameter</li>
</ul>
</div>
<div class="incremental">
<ul>
<li><code>HoistInterpretation</code> is the distribution law</li>
</ul>
<hr />
<div class="sourceCode" id="cb92"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb92-1" title="1"><span class="kw">type</span> <span class="dt">WithTactics</span> e tk m r <span class="fu">=</span> <span class="dt">Tactics</span> tk m (e &#39;<span class="fu">:</span> r) &#39;<span class="fu">:</span> r</a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb93"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb93-1" title="1">pureT</a>
<a class="sourceLine" id="cb93-2" title="2"><span class="ot">   ::</span> a</a>
<a class="sourceLine" id="cb93-3" title="3">   <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">WithTactics</span> e tk m r) (tk a)</a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb94"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb94-1" title="1">runT</a>
<a class="sourceLine" id="cb94-2" title="2"><span class="ot">    ::</span> m a</a>
<a class="sourceLine" id="cb94-3" title="3">    <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">WithTactics</span> e tk m r)</a>
<a class="sourceLine" id="cb94-4" title="4">                (<span class="dt">Free</span> (e &#39;<span class="fu">:</span> r) (tk a))</a></code></pre></div>
</div>
<div class="incremental">
<div class="sourceCode" id="cb95"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb95-1" title="1">bindT</a>
<a class="sourceLine" id="cb95-2" title="2"><span class="ot">    ::</span> (a <span class="ot">-&gt;</span> m b)</a>
<a class="sourceLine" id="cb95-3" title="3">    <span class="ot">-&gt;</span> <span class="dt">Free</span> (<span class="dt">WithTactics</span> e tk m r)</a>
<a class="sourceLine" id="cb95-4" title="4">                (tk a <span class="ot">-&gt;</span> <span class="dt">Free</span> (e &#39;<span class="fu">:</span> r) (tk b))</a></code></pre></div>
<hr />
<p>This is where we stop.</p>
</div>
<div class="incremental">
<p>We’ve now simultaneously solved the boilerplate and performance problems, as well as put a friendly UX around the whole thing.</p>
<hr />
<p>I’d like to leave you with a comparison.</p>
</div>
<div class="incremental">
<p>First, the implementation of <code>bracket</code> in <code>fused-effects</code>:</p>
<hr />
<div class="sourceCode" id="cb96"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb96-1" title="1"></a>
<a class="sourceLine" id="cb96-2" title="2"><span class="kw">data</span> <span class="dt">Resource</span> m k</a>
<a class="sourceLine" id="cb96-3" title="3">  <span class="fu">=</span> <span class="kw">forall</span> resource <span class="fu">any</span> output<span class="fu">.</span></a>
<a class="sourceLine" id="cb96-4" title="4">      <span class="dt">Resource</span> (m resource)</a>
<a class="sourceLine" id="cb96-5" title="5">               (resource <span class="ot">-&gt;</span> m <span class="fu">any</span>)</a>
<a class="sourceLine" id="cb96-6" title="6">               (resource <span class="ot">-&gt;</span> m output)</a>
<a class="sourceLine" id="cb96-7" title="7">               (output <span class="ot">-&gt;</span> k)</a>
<a class="sourceLine" id="cb96-8" title="8"></a>
<a class="sourceLine" id="cb96-9" title="9"><span class="kw">deriving</span> <span class="kw">instance</span> <span class="dt">Functor</span> (<span class="dt">Resource</span> m)</a>
<a class="sourceLine" id="cb96-10" title="10"></a>
<a class="sourceLine" id="cb96-11" title="11"><span class="kw">instance</span> <span class="dt">HFunctor</span> <span class="dt">Resource</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb96-12" title="12">  hmap f (<span class="dt">Resource</span> acquire release use k) <span class="fu">=</span></a>
<a class="sourceLine" id="cb96-13" title="13">    <span class="dt">Resource</span> (f acquire) (f <span class="fu">.</span> release) (f <span class="fu">.</span> use) k</a>
<a class="sourceLine" id="cb96-14" title="14"></a>
<a class="sourceLine" id="cb96-15" title="15"><span class="kw">instance</span> <span class="dt">Effect</span> <span class="dt">Resource</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb96-16" title="16">  handle state handler (<span class="dt">Resource</span> acquire release use k)</a>
<a class="sourceLine" id="cb96-17" title="17">    <span class="fu">=</span> <span class="dt">Resource</span> (handler (acquire <span class="fu">&lt;$</span> state))</a>
<a class="sourceLine" id="cb96-18" title="18">               (handler <span class="fu">.</span> <span class="fu">fmap</span> release)</a>
<a class="sourceLine" id="cb96-19" title="19">               (handler <span class="fu">.</span> <span class="fu">fmap</span> use)</a>
<a class="sourceLine" id="cb96-20" title="20">               (handler <span class="fu">.</span> <span class="fu">fmap</span> k)</a>
<a class="sourceLine" id="cb96-21" title="21"></a>
<a class="sourceLine" id="cb96-22" title="22"><span class="ot">bracket ::</span> (<span class="dt">Member</span> <span class="dt">Resource</span> sig, <span class="dt">Carrier</span> sig m)</a>
<a class="sourceLine" id="cb96-23" title="23">        <span class="ot">=&gt;</span> m resource</a>
<a class="sourceLine" id="cb96-24" title="24">        <span class="ot">-&gt;</span> (resource <span class="ot">-&gt;</span> m <span class="fu">any</span>)</a>
<a class="sourceLine" id="cb96-25" title="25">        <span class="ot">-&gt;</span> (resource <span class="ot">-&gt;</span> m a)</a>
<a class="sourceLine" id="cb96-26" title="26">        <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb96-27" title="27">bracket acquire release use <span class="fu">=</span></a>
<a class="sourceLine" id="cb96-28" title="28">  send (<span class="dt">Resource</span> acquire release use <span class="fu">pure</span>)</a>
<a class="sourceLine" id="cb96-29" title="29"></a>
<a class="sourceLine" id="cb96-30" title="30"><span class="ot">runResource ::</span> (<span class="kw">forall</span> x <span class="fu">.</span> m x <span class="ot">-&gt;</span> <span class="dt">IO</span> x)</a>
<a class="sourceLine" id="cb96-31" title="31">            <span class="ot">-&gt;</span> <span class="dt">ResourceC</span> m a</a>
<a class="sourceLine" id="cb96-32" title="32">            <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb96-33" title="33">runResource handler <span class="fu">=</span> runReader (<span class="dt">Handler</span> handler) <span class="fu">.</span> runResourceC</a>
<a class="sourceLine" id="cb96-34" title="34"></a>
<a class="sourceLine" id="cb96-35" title="35"><span class="kw">newtype</span> <span class="dt">ResourceC</span> m a <span class="fu">=</span> <span class="dt">ResourceC</span></a>
<a class="sourceLine" id="cb96-36" title="36">  {<span class="ot"> runResourceC ::</span> <span class="dt">ReaderC</span> (<span class="dt">Handler</span> m) m a</a>
<a class="sourceLine" id="cb96-37" title="37">  }</a>
<a class="sourceLine" id="cb96-38" title="38">  <span class="kw">deriving</span> ( <span class="dt">Alternative</span>, <span class="dt">Applicative</span>, <span class="dt">Functor</span>, <span class="dt">Monad</span>, <span class="dt">MonadFail</span>, <span class="dt">MonadIO</span>, <span class="dt">MonadPlus</span>)</a>
<a class="sourceLine" id="cb96-39" title="39"></a>
<a class="sourceLine" id="cb96-40" title="40"><span class="kw">instance</span> <span class="dt">MonadTrans</span> <span class="dt">ResourceC</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb96-41" title="41">  lift <span class="fu">=</span> <span class="dt">ResourceC</span> <span class="fu">.</span> lift</a>
<a class="sourceLine" id="cb96-42" title="42"></a>
<a class="sourceLine" id="cb96-43" title="43"><span class="kw">newtype</span> <span class="dt">Handler</span> m <span class="fu">=</span> <span class="dt">Handler</span> (<span class="kw">forall</span> x <span class="fu">.</span> m x <span class="ot">-&gt;</span> <span class="dt">IO</span> x)</a>
<a class="sourceLine" id="cb96-44" title="44"></a>
<a class="sourceLine" id="cb96-45" title="45"><span class="ot">runHandler ::</span> <span class="dt">Handler</span> m <span class="ot">-&gt;</span> <span class="dt">ResourceC</span> m a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</a>
<a class="sourceLine" id="cb96-46" title="46">runHandler h<span class="fu">@</span>(<span class="dt">Handler</span> handler) <span class="fu">=</span> handler <span class="fu">.</span> runReader h <span class="fu">.</span> runResourceC</a>
<a class="sourceLine" id="cb96-47" title="47"></a>
<a class="sourceLine" id="cb96-48" title="48"><span class="kw">instance</span> (<span class="dt">Carrier</span> sig m, <span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span></a>
<a class="sourceLine" id="cb96-49" title="49">      <span class="dt">Carrier</span> (<span class="dt">Resource</span> <span class="fu">:+:</span> sig) (<span class="dt">ResourceC</span> m) <span class="kw">where</span></a>
<a class="sourceLine" id="cb96-50" title="50">  eff (<span class="dt">L</span> (<span class="dt">Resource</span> acquire release use k)) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb96-51" title="51">    handler <span class="ot">&lt;-</span> <span class="dt">ResourceC</span> ask</a>
<a class="sourceLine" id="cb96-52" title="52">    a <span class="ot">&lt;-</span> liftIO (Exc.bracket</a>
<a class="sourceLine" id="cb96-53" title="53">      (runHandler handler acquire)</a>
<a class="sourceLine" id="cb96-54" title="54">      (runHandler handler <span class="fu">.</span> release)</a>
<a class="sourceLine" id="cb96-55" title="55">      (runHandler handler <span class="fu">.</span> use))</a>
<a class="sourceLine" id="cb96-56" title="56">    k a</a>
<a class="sourceLine" id="cb96-57" title="57">  eff (<span class="dt">R</span> other) <span class="fu">=</span> <span class="dt">ResourceC</span> (eff (<span class="dt">R</span> (handleCoercible other)))</a></code></pre></div>
<hr />
<p>Compare to <code>polysemy</code>:</p>
<hr />
<div class="sourceCode" id="cb97"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb97-1" title="1"></a>
<a class="sourceLine" id="cb97-2" title="2"><span class="kw">data</span> <span class="dt">Resource</span> m a <span class="kw">where</span></a>
<a class="sourceLine" id="cb97-3" title="3">  <span class="dt">Bracket</span><span class="ot"> ::</span> m a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m ()) <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m b) <span class="ot">-&gt;</span> <span class="dt">Resource</span> m b</a>
<a class="sourceLine" id="cb97-4" title="4"></a>
<a class="sourceLine" id="cb97-5" title="5">makeSemantic &#39;<span class="dt">&#39;Resource</span></a>
<a class="sourceLine" id="cb97-6" title="6"></a>
<a class="sourceLine" id="cb97-7" title="7"></a>
<a class="sourceLine" id="cb97-8" title="8">runResource</a>
<a class="sourceLine" id="cb97-9" title="9"><span class="ot">    ::</span> <span class="dt">Member</span> (<span class="dt">Lift</span> <span class="dt">IO</span>) r</a>
<a class="sourceLine" id="cb97-10" title="10">    <span class="ot">=&gt;</span> (<span class="ot">∀</span> x<span class="fu">.</span> <span class="dt">Semantic</span> r x <span class="ot">-&gt;</span> <span class="dt">IO</span> x)</a>
<a class="sourceLine" id="cb97-11" title="11">    <span class="ot">-&gt;</span> <span class="dt">Semantic</span> (<span class="dt">Resource</span> &#39;<span class="fu">:</span> r) a</a>
<a class="sourceLine" id="cb97-12" title="12">    <span class="ot">-&gt;</span> <span class="dt">Semantic</span> r a</a>
<a class="sourceLine" id="cb97-13" title="13">runResource finish <span class="fu">=</span> interpretH <span class="fu">$</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb97-14" title="14">  <span class="dt">Bracket</span> alloc dealloc use <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb97-15" title="15">    a <span class="ot">&lt;-</span> runT  alloc</a>
<a class="sourceLine" id="cb97-16" title="16">    d <span class="ot">&lt;-</span> bindT dealloc</a>
<a class="sourceLine" id="cb97-17" title="17">    u <span class="ot">&lt;-</span> bindT use</a>
<a class="sourceLine" id="cb97-18" title="18"></a>
<a class="sourceLine" id="cb97-19" title="19">    <span class="kw">let</span> runIt <span class="fu">=</span> finish <span class="fu">.@</span> runResource</a>
<a class="sourceLine" id="cb97-20" title="20">    sendM <span class="fu">$</span> X.bracket (runIt a) (runIt <span class="fu">.</span> d) (runIt <span class="fu">.</span> u)</a></code></pre></div>
<hr />
</div>
<h2 id="shoutouts">Shoutouts</h2>
<blockquote>
<p>My girlfriend Virginie for putting up with me talking about free monads for two months.</p>
</blockquote>
<div class="incremental">
<blockquote>
<p>Li-Yao Xia for showing me the final encoding of <code>Freer</code>.</p>
</blockquote>
</div>
<div class="incremental">
<blockquote>
<p>Rob Rix for sitting down with me and explaining how the heck <code>fused-effects</code> is so fast.</p>
</blockquote>
<hr />
</div>
</div>
<h1 id="thanks-for-listening">Thanks for listening!</h1>
<div class="incremental">
<p>Questions?</p>
</div>

<p class="meta">
</p>

</div>

<div class="comments">
    <div id="disqus_thread"></div>
    <script>
    var disqus_config = function () {
        var slug = "polysemy-talk";
        this.page.url = "http://reasonablypolymorphic.com/blog/" + slug;
        this.page.identifier = slug;
    };
    (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://reasonablypolymorphic.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>
      Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
</div>
</article>

</div>
    <nav>
        <h1><a href="/">REASONABLY<br/>POLYMORPHIC</a></h1>
    
        <p> Hi there. I'm <strong>Sandy Maguire</strong>. I like improving life and
        making cool things.</p>
    
        <p>If you want to get in touch, I'd love to hear from you! Send me an
        email; you can contact me via <tt><b>sandy</b></tt> at <tt><b>sandymaguire.me</b></tt>.</p>
    
        <h2>SITE LINKS</h2>
        <ul>
            <li><a href="/blog/archives/">Archives</a></li>
            <li><a href="/talks">Talks</a></li>
        </ul>
    
        <h2>THINGS I MAKE</h2>
        <ul>
            <li>Code on <a href="http://github.com/isovector">github</a></li>
            <li>Book <a href="/book/preface">archive</a></li>
            <li>My other <a href="http://sandymaguire.me">blog</a></li>
        </ul>
    
        <h2>WHAT I'M DOING</h2>
        <ul>
            <li><a href="/erdos">Erdos Project</a></li>
            <li>Music at <a href="http://last.fm/user/Paamayim">last.fm</a></li>
            <li>Books at <a href="https://www.goodreads.com/review/list/14945161-sandy-maguire?shelf=currently-reading">goodreads</a></li>
            <li>Papers at <a href="https://www.mendeley.com/groups/7295141/read/papers/">mendeley</a></li>
        </ul>
    
        <p>
        &copy; 2015-2019 Sandy Maguire
        </p>
    </nav>

    <div id="smallnav">
      <div class="smallhome"><a href="/">REASONABLY POLYMORPHIC</a></div>
      <div class="smallarchives"><a href="/blog/archives/">ARCHIVES</a></div>
    </div>
</body>
</html>

